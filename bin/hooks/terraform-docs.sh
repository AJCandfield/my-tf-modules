#!/bin/bash

# -----------------------------------------------------------------------------
# This script has been automatically generated by an AI language model.
# While efforts have been made to ensure correctness, please review and test before use.
# The owner of thir project  assumes no liability for issues arising from the use of this script.
# -----------------------------------------------------------------------------

set -e

# Ensure terraform-docs is installed
if ! command -v terraform-docs &>/dev/null; then
  echo "Error: terraform-docs is not installed. Install it from https://terraform-docs.io/"
  exit 1
fi

# Get list of staged Terraform files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=AM | grep -E '^modules/.+/.+\.tf$' || true)

# Extract unique module directories
MODULE_DIRS=$(echo "$STAGED_FILES" | awk -F'/' '{print $1"/"$2"/"$3}' | sort -u)

# Exit if no Terraform module files are staged
if [ -z "$MODULE_DIRS" ]; then
  exit 0
fi

# Run terraform-docs for each module
for MODULE in $MODULE_DIRS; do
  if [ -f "$MODULE/main.tf" ]; then
    echo "Generating documentation for $MODULE..."
    terraform-docs markdown table --output-file README.md --output-mode inject "$MODULE"
  fi
done
